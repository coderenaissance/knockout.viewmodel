-//v2.0.3 - C 2013, Dave Herren, License: MIT 
(function(){function a(e,t){var n=e?e[t.full]||e[t.parent]||e[t.name]||{}:{};if(s)s(t,n,e);return n}function f(e){var t={},n=e?e.shared||{}:{},r,i,s,o,u,a,f,l;for(a in e){r=e[a]||{};if(a==="shared")continue;else if(r instanceof Array){for(s=0,u=r.length;s<u;s++){o=r[s];t[o]=t[o]||{};t[o][a]=true;t[o].settingType=t[o].settingType?"multiple":a}}else if(r.constructor===Object){for(o in r){t[o]=t[o]||{};i=r[o];i=a!=="arrayChildId"&&i&&i.constructor===String&&n[i]?n[i]:i;if(i&&i.constructor===Object){for(f in i){if((l=i[f])&&l.constructor==String&&n[l]){i[f]=n[l]}}}t[o][a]=i;t[o].settingType=t[o].settingType?"multiple":a}}}return t}function l(e){return e===null||e===undefined}function c(e){return e===null||e===undefined||e.constructor===String||e.constructor===Number||e.constructor===Boolean||e instanceof Date}function h(e,t,i,s){var f,d,v,m,g,y,b,w,E,S,x;s=s||a(t,i);if(b=s.custom){E=true;if(typeof b==="function"){d=b(e);if(!l(d)){d.___$mapCustom=b}}else{d=b.map(e);if(!l(d)){d.___$mapCustom=b.map;if(b.unmap){d.___$unmapCustom=b.unmap}}}}else if(s.append){E=true;d=e}else if(s.exclude){E=true;return u}else if(c(e)){d=i.parentIsArray?e:n(e)}else if(e instanceof Array){d=[];for(v=0,m=e.length;v<m;v++){d[v]=h(e[v],t,{name:"[i]",parent:i.name+"[i]",full:i.full+"[i]",parentIsArray:true})}if(!i.parentIsArray||o){y={name:"[i]",parent:i.name+"[i]",full:i.full+"[i]",parentIsArray:true};d=r(d);if(g=s.arrayChildId){d.___$childIdName=g}d.pushFromModel=function(e){e=h(e,t,y);d.push(e)};d.unshiftFromModel=function(e){e=h(e,t,y);d.unshift(e)};d.spliceFromModel=function(e,n,r){r=h(r,t,y);d.splice(e,n,r)};d.popToModel=function(e){e=d.pop();return p(e,y)};d.shiftToModel=function(e){e=d.shift();return p(e,y)}}}else if(e.constructor===Object){d={};for(v in e){y={name:v,parent:(i.name==="[i]"?i.parent:i.name)+"."+v,full:i.full+"."+v};x=e[v];S=c(x)?a(t,y):undefined;if(S&&S.custom){d.___$customChildren=d.___$customChildren||{};d.___$customChildren[v]=S.custom;if(typeof S.custom==="function"){d[v]=S.custom(e[v])}else{d[v]=S.custom.map(e[v])}}else{f=h(x,t,y,S);if(f!==u){d[v]=f}}}}if(!E&&(w=s.extend)){if(typeof w==="function"){d=w(d)||d}else if(w.constructor===Object){if(typeof w.map==="function"){d=w.map(d)||d}if(typeof w.unmap==="function"){d.___$unmapExtend=w.unmap}}}return d}function p(t,n){var r,i,o,a,f=e(t),h,d,v=t!==f;if(s){s(n)}if(!v&&t&&t.constructor===Function){return u}else if(t&&t.___$unmapCustom){r=t.___$unmapCustom(t)}else if(v&&c(f)||l(f)){r=f}else if(f instanceof Array){r=[];for(i=0,o=f.length;i<o;i++){r[i]=p(f[i],{name:"[i]",parent:n.name+"[i]",full:n.full+"[i]"})}}else if(f.constructor===Object){r={};for(i in f){if(i.substr(0,4)!=="___$"){if(t.___$customChildren&&t.___$customChildren[i]&&t.___$customChildren[i].unmap){r[i]=t.___$customChildren[i].unmap(f[i])}else{h=f[i];if(!ko.isComputed(h)&&!((a=e(h))&&a.constructor===Function)){d=p(h,{name:i,parent:(n.name==="[i]"?n.parent:n.name)+"."+i,full:n.full+"."+i});if(d!==u){r[i]=d}}}}}}else{if(!v&&typeof f!=="function"){r=f}}if(t&&t.___$unmapExtend){r=t.___$unmapExtend(r,t)}return r}function d(n,r,i,o,u){var a,f,h,p,v,m,g,y,b=e(r),w=r!==b,E,S,x,T,N,C,k;if(s){s(i)}if(w&&l(b)^l(n)){r(n)}else if(n&&b&&b.constructor==Object&&n.constructor===Object){for(a in n){if(r.___$customChildren&&r.___$customChildren[a]){N=r.___$customChildren[a].map||r.___$customChildren[a];b[a]=N(n[a])}else{E=b[a];if(!w&&b.hasOwnProperty(a)&&(c(E)||E&&E.constructor===Array)){b[a]=n[a]}else if(E&&typeof E.___$mapCustom==="function"){if(t(E)){T=E.___$mapCustom(n[a],E);T=e(T);E(T)}else{b[a]=E.___$mapCustom(n[a],E)}}else if(l(n[a])&&b[a]&&b[a].constructor===Object){b[a]=n[a]}else{if(!!u){var L=function(e,t,n){return function(){d(e[n],b[n],{name:n,parent:(i.name==="[i]"?i.parent:i.name)+"."+n,full:i.full+"."+n},b,u);u(u()-1)}}(n,r,a);u(u()+1);setTimeout(L,0)}else{d(n[a],b[a],{name:a,parent:(i.name==="[i]"?i.parent:i.name)+"."+a,full:i.full+"."+a})}}}}}else if(b&&b instanceof Array){if(g=r.___$childIdName){h=[];p=[];for(a=n.length-1;a>=0;a--){v=n[a][g];for(f=b.length-1;f>=0;f--){E=b[f];C=e(E);m=e(C[g]);if(m===v){if(E.___$mapCustom){if(ko.isObservable(E)){k=E.___$mapCustom(n[a],E);if(t(k)&&k!=E){E(e(k))}}else{b[f]=E.___$mapCustom(n[a],E)}}else{if(!!u){var A=function(e,t,n,r){return function(){d(e[n],b[r],{name:"[i]",parent:i.name+"[i]",full:i.full+"[i]"},undefined,u);u(u()-1)}}(n,r,a,f);u(u()+1);setTimeout(A,0)}else{d(n[a],b[f],{name:"[i]",parent:i.name+"[i]",full:i.full+"[i]"})}}p[f]=true;h[a]=true;break}}}for(f=b.length-1;f>=0;f--){if(!p[f]){r.splice(f,1)}}for(a=n.length-1;a>=0;a--){if(!h[a]){r.pushFromModel(n[a])}}}else{x=[];S=r.___$mapCustom;if(typeof S==="function"){for(a=0,y=n.length;a<y;a++){x[a]=n[a]}r(S(x))}else{r(x);for(a=0,y=n?n.length:0;a<y;a++){r.pushFromModel(n[a])}}}}else if(w){r(n)}if(i.name==="{root}"&&!!u){return{onComplete:function(e){if(e&&typeof e=="function"){if(!!u){ko.computed(function(){if(e&&u()===0){e();e=undefined}}).extend({throttle:50})}else{e()}}}}}}function v(e,t){o=e.makeChildArraysObservable;if(window.console&&e.logging){console.log(t);s=function(t,n,r){var i;if(n&&n.settingType){i=n.settingType+" "+t.full+" (matched: '"+((r[t.full]?t.full:"")||(r[t.parent]?t.parent:"")||t.name)+"')"}else{i="default "+t.full}console.log("- "+i)}}else{s=undefined}}var e=ko.utils.unwrapObservable,t=ko.isObservable,n=ko.observable,r=ko.observableArray,i={name:"{root}",parent:"{root}",full:"{root}"},s,o,u=function(){};ko.viewmodel={options:{makeChildArraysObservable:true,logging:false},fromModel:function(t,n){var r=f(n);v(this.options,"Mapping From Model");return h(t,r,i)},toModel:function(t){v(this.options,"Mapping To Model");return p(t,i)},updateFromModel:function(t,n,r){var s=r?ko.observable(0):undefined;v(this.options,"Update From Model");return d(n,t,i,undefined,s)}}})()